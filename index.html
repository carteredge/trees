<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
    </head>
    <body>
        <div id="page-root">
            <h1>Click to plant trees.</h1>
            <span>(Refresh to start over.)</span>
        </div>
        
        <script>
            const BRANCH_DENSITY = 150;
            const FADE = 0.85;
            const MIN_OPACITY = 0.03;
            const GROWTH_DECAY = 0.68;
            const LEAF_RADIUS = 32;
            const LEAF_SPROUT_RADIUS = 4;
            const LONG_DELAY = 500;
            const MAX_GROWTH = (window.innerHeight ?? window.offsetHeight) * 0.75;
            const MIN_GROWTH = 50;
            const SEED_RADIUS = 8;
            const SHORT_DELAY = 50;

            function fadeForest() {
                const flora = document.querySelectorAll("h1, span, .seed");
                for (let element of flora) {
                    element.style.opacity = (Number(window.getComputedStyle(element).opacity) * FADE).toString();
                    if (Number(element.style.opacity) < MIN_OPACITY) {
                        element.remove();
                    }
                }
            }

            function getTop(element) {
                let top = 0;
                do {
                    if (!isNaN(element.offsetTop)) {
                        top += element.offsetTop;
                    }
                } while(element = element.offsetParent);
                return top;
            }

            function growBranch(tree, growthBase, direction, lastDirection="up") {
                const maxGrowth = growthBase * GROWTH_DECAY;
                if (maxGrowth > MIN_GROWTH) {
                    let growth = Math.round(Math.random() * maxGrowth);
                    const branch = document.createElement("div");
                    branch.className = "branch";
                    switch (direction) {
                        case "down":
                            branch.style.top = `${SEED_RADIUS}px`;
                            branch.style.left = `${Math.round(Math.random() * (tree.offsetWidth - 2 * SEED_RADIUS) + SEED_RADIUS)}px`;
                            tree.append(branch);
                            setTimeout(() => {
                                const pageRoot = document.getElementById("page-root");
                                const altitudeAdjustment = (getTop(branch) - branch.offsetHeight / 2) / pageRoot.offsetHeight;
                                growth = Math.max(growth * altitudeAdjustment, SEED_RADIUS * 2);
                                branch.style.height = `${growth}px`;
                                setTimeout(() => {
                                    growBranches(branch, growth, Math.random() < 0.5 ? "left" : "right", direction);
                                }, LONG_DELAY);
                            }, SHORT_DELAY);
                            break;
                        case "left":
                            branch.style.top = `${Math.round(Math.random() * (tree.offsetHeight - 2 * SEED_RADIUS) + SEED_RADIUS)}px`;
                            branch.style.right = `${SEED_RADIUS}px`;
                            tree.append(branch);
                            setTimeout(() => {
                                const pageRoot = document.getElementById("page-root");
                                const altitudeAdjustment = (getTop(branch) - branch.offsetHeight / 2) / pageRoot.offsetHeight;
                                growth = Math.max(growth * altitudeAdjustment, SEED_RADIUS * 2);
                                branch.style.width = `${growth}px`;
                                setTimeout(() => {
                                    growBranches(branch, growth, Math.random() < 0.5 ? "up" : "down", direction);
                                }, LONG_DELAY);
                            }, SHORT_DELAY);
                            break;
                        case "right":
                            branch.style.top = `${Math.round(Math.random() * (tree.offsetHeight - 2 * SEED_RADIUS) + SEED_RADIUS)}px`;
                            branch.style.left = `${SEED_RADIUS}px`;
                            tree.append(branch);
                            setTimeout(() => {
                                const pageRoot = document.getElementById("page-root");
                                const altitudeAdjustment = (getTop(branch) - branch.offsetHeight / 2) / pageRoot.offsetHeight;
                                growth = Math.max(growth * altitudeAdjustment, SEED_RADIUS * 2);
                                branch.style.width = `${growth}px`;
                                setTimeout(() => {
                                    growBranches(branch, growth, Math.random() < 0.5 ? "up" : "down", direction);
                                }, LONG_DELAY);
                            }, SHORT_DELAY);
                            break;
                        case "up":
                        default:
                            branch.style.bottom = `${SEED_RADIUS}px`;
                            branch.style.left = `${Math.round(Math.random() * (tree.offsetWidth - 2 * SEED_RADIUS) + SEED_RADIUS)}px`;
                            tree.append(branch);
                            setTimeout(() => {
                                const pageRoot = document.getElementById("page-root");
                                const altitudeAdjustment = (getTop(branch) - branch.offsetHeight / 2) / pageRoot.offsetHeight;
                                growth = Math.max(growth * altitudeAdjustment, SEED_RADIUS * 2);
                                branch.style.height = `${growth}px`;
                                setTimeout(() => {
                                    growBranches(branch, growth, Math.random() < 0.5 ? "left" : "right", direction);
                                }, LONG_DELAY);
                            }, SHORT_DELAY);
                            break;
                    }
                }
                const leaf = document.createElement("div");
                leaf.className = "leaf";
                switch (lastDirection) {
                    case "down":
                        leaf.style.bottom = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        leaf.style.left = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        tree.append(leaf);
                        setTimeout(() => {
                            leaf.style.width = `${LEAF_RADIUS * 2}px`;
                            leaf.style.height = `${LEAF_RADIUS * 2}px`;
                            leaf.style.bottom = `${SEED_RADIUS - LEAF_RADIUS}px`;
                            leaf.style.left = `${SEED_RADIUS - LEAF_RADIUS}px`;
                        }, SHORT_DELAY);
                        break;
                    case "left":
                        leaf.style.top = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        leaf.style.left = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        tree.append(leaf);
                        setTimeout(() => {
                            leaf.style.width = `${LEAF_RADIUS * 2}px`;
                            leaf.style.height = `${LEAF_RADIUS * 2}px`;
                            leaf.style.top = `${SEED_RADIUS - LEAF_RADIUS}px`;
                            leaf.style.left = `${SEED_RADIUS - LEAF_RADIUS}px`;
                        }, SHORT_DELAY);
                        break;
                    case "right":
                        leaf.style.top = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        leaf.style.right = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        tree.append(leaf);
                        setTimeout(() => {
                            leaf.style.width = `${LEAF_RADIUS * 2}px`;
                            leaf.style.height = `${LEAF_RADIUS * 2}px`;
                            leaf.style.top = `${SEED_RADIUS - LEAF_RADIUS}px`;
                            leaf.style.right = `${SEED_RADIUS - LEAF_RADIUS}px`;
                        }, SHORT_DELAY);
                        break;
                    case "up":
                    default:
                        leaf.style.top = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        leaf.style.left = `${SEED_RADIUS - LEAF_SPROUT_RADIUS}px`;
                        tree.append(leaf);
                        setTimeout(() => {
                            leaf.style.width = `${LEAF_RADIUS * 2}px`;
                            leaf.style.height = `${LEAF_RADIUS * 2}px`;
                            leaf.style.top = `${SEED_RADIUS - LEAF_RADIUS}px`;
                            leaf.style.left = `${SEED_RADIUS - LEAF_RADIUS}px`;
                        }, SHORT_DELAY);
                        break;
                }
            }

            function growBranches(tree, growthBase, direction, lastDirection) {
                const count = Math.max(Math.round((growthBase / BRANCH_DENSITY) * Math.random()), 1);
                for (let i = count; i--;) {
                    growBranch(tree, growthBase, direction, lastDirection);
                }
            }

            function growSeed(seed) {
                const seedTop = seed.offsetTop;
                const seedBottom = seed.offsetTop + seed.offsetHeight;
                const growth = Math.max(Math.round(Math.random() * MAX_GROWTH), MIN_GROWTH);
                seed.style.height = `${growth}px`;

                setTimeout(() => {
                    growBranches(
                        seed,
                        growth,
                        "left");
                    growBranches(
                        seed,
                        growth,
                        "right");
                }, LONG_DELAY);
            }

            function plantSeed(event) {
                fadeForest();
                const pageRoot = document.getElementById("page-root");
                const seed = document.createElement("div");
                seed.className = "seed";
                seed.style.bottom = `${window.innerHeight - event.clientY - SEED_RADIUS}px`;
                seed.style.left = `${event.clientX - SEED_RADIUS}px`;
                pageRoot.appendChild(seed);
                setTimeout(() => {
                    seed.style.bottom = "0";
                    seed.style.top = undefined;
                    setTimeout(() => growSeed(seed), LONG_DELAY)
                }, SHORT_DELAY);
            }

            document.getElementById("page-root").addEventListener("click", plantSeed);
        </script>

        <style>
            body {
                background-color: #bdf;
            }

            h1, span {
                color: #048;
                display: block;
                font-family: serif;
                font-style: italic;
                margin: 2rem auto;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                text-align: center;
            }

            .branch, .seed {
                background-color: #842;
                border-radius: 8px;
                height: 16px;
                position: absolute;
                transition: all 0.5s ease-in 0s;
                width: 16px;
            }

            .leaf {
                background-color: #482;
                border-radius: 50%;
                height: 8px;
                position: absolute;
                transition: all 0.5s ease-in 0s;
                width: 8px;
            }

            #page-root {
                bottom: 0;
                left: 0;
                right: 0;
                overflow: hidden;
                position: absolute;
                top: 0;
            }
        </style>
    </body>
</html>